##########
# GITHUB #
##########

# DOC
# https://github.com/actions/starter-workflows/

name: Sym-play

on:
  push:
    branches: [ main ]

###
# Jobs
###
jobs:
  #########
  # TESTS #
  #########
  tests:
    runs-on: ubuntu-latest
    name: Tests
    strategy:
      fail-fast: false

    steps:
    - uses: actions/checkout@v2

    # Php, composer, ext, xdebug
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        coverage: xdebug
        extensions: curl, gd, intl, mbstring, opcache, sockets, sodium, xsl, zip
        php-version: "7.3"

    - name: Symfony cli
      run: make symfony-bin

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v2
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install composer dependencies
      if: steps.composer-cache.outputs.cache-hit != 'true'
      # --no-plugins avoid to install grumphp's git hook
      run: composer install --prefer-dist --no-progress --no-dev

    - name: Install sqlite for messenger
      run: apt update && apt install -y sqlite3

    - name: Tests
      run: make tests